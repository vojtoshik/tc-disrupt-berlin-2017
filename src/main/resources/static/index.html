<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css"
      integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw=="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet-src.js"
      integrity="sha384-TWB9xRHTlLQmqAngHwD7usGcf4akGf0JP6aHwlgilpmOu2UuBq5aWLsDAh39iSn1"
      crossorigin=""></script>
    <script src="https://releases.route360.net/r360-js/latest.js"></script>


    <!-- Load Esri Leaflet locally, after cloning this repository -->
    <script src="https://unpkg.com/esri-leaflet@2.1.1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

    <style>
      html, body, #map {
        margin:0; padding:0;  width : 100%; height : 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
		var greenIcon = L.icon({
			iconUrl: 'https://cdn4.iconfinder.com/data/icons/checkout-icons/32x32/house.png',
		});
		var cities = L.layerGroup();

		var map = L.map('map', {layers: [cities]}).setView([52.53, 13.381], 13);
		L.esri.basemapLayer("Gray").addTo(map);

		var overlays = {
			"Parameter 1": cities,
			"Parameter 2": cities,
			"Parameter 3": cities,
			"Parameter 4": cities,
			"Parameter 5": cities,
			"Parameter 6": cities,
			"Parameter 7": cities,
		};
		L.control.layers({}, overlays).addTo(map);

        var addressPoints = [
                [52.53, 13.381, 10], // lat, lng, intensity
                [52.54, 13.382, 9],
                [52.55, 13.383, 9],
                [52.56, 13.384, 9],
                [52.57, 13.385, 9],
                [52.58, 13.386, 9],
                [52.59, 13.387, 9],
                [52.60, 13.388, 8.5]];
//        var heat = L.heatLayer(addressPoints,{radius: 12}).addTo(map);

        //изохрона
        var latlon = [52.53, 13.381];


         var markerA = L.marker((latlon),{ draggable: true }).addTo(map);
         var polygonLayer = r360.leafletPolygonLayer({ inverse: true }).addTo(map);
         polygonLayer.setColors([{
              'time': 600,
              'opacity' : 0.5
            }, {
              'time': 1200,
               'opacity' : 0.2
            }, ]);
         var showPolygons = function(rezoom) {
             var travelOptions = r360.travelOptions();
                travelOptions.setServiceKey('3WQ8V9LAR8PIAE6T5LRZMBT');
                travelOptions.addSource(markerA);
                travelOptions.setTravelTimes([600, 1200]);
                travelOptions.setTravelType('transit');
                travelOptions.setServiceUrl('https://service.route360.net/germany/');

            r360.PolygonService.getTravelTimePolygons(travelOptions, function(polygons){
                polygonLayer.clearAndAddLayers(polygons, rezoom || false);
            });
        };
        showPolygons(true);
        markerA.on('dragend', function(){ showPolygons(false); });

        var noiseStyle = {
            "color": "#ff7800",
            "weight": 5,
            "opacity": 0.65
        };
        $.ajax({
          url: 'osm',
          data: {
            category:28,
            lon: 13,
            lat: 52,
            radiusMeters:500000,
            n: 1000
          },
          success: function(data){
            $.each(data, function() {
                    var poi = [this.lon,this.lat,this.score];
                    var rand = Math.random();
                    if (rand < 0.1){
                          L.marker([this.lat,this.lon], {icon: greenIcon}).addTo(map);
                    }
//                        result.push(poi);

                });
//            result.push([52.64,13.291]);
//            L.geoJSON(result, { style: noiseStyle}).addTo(map);

          },
          dataType: 'json'
        });

        $.ajax({
          url: 'osm_grid',
          data: {
            category:'26,27,28',
            precision: 9,
          },
          success: function(data){
            var resultHeat = [];
            var result = [];
            var max = 0;
            $.each(data, function() {
                    var poi = [this.lat,this.lon,this.count];
                    resultHeat.push(poi);
                    if (this.count > max){
                      max=this.count;
                    }
                });
            $.each(resultHeat, function() {
              this[2]/=max*2;
            });


            var heat = L.heatLayer(resultHeat,{radius: 50,gradient : {0.1: 'blue', 0.25: 'blue', 0.5: 'blue'},minOpacity:0.1}).addTo(map);
            console.log(resultHeat.length);
            console.log(max);

          },
          dataType: 'json'
        });

    </script>
  </body>
</html>